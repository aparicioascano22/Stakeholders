<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Popeyes ‚Äî Stakeholder: Banco</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent-orange:#FF7A2D;
      --accent-red:#E23A2B;
      --bg-soft:#FFF7F1;
      --card:#ffffff;
      --text:#222;
      --muted:#666;
      --success:#10b981;
      --warning:#f59e0b;
      --error:#ef4444;
      --shadow-sm:0 1px 3px rgba(0,0,0,0.08);
      --shadow-md:0 10px 30px rgba(0,0,0,0.06);
      --shadow-lg:0 20px 50px rgba(0,0,0,0.10);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Poppins",sans-serif;
      background:linear-gradient(135deg,var(--bg-soft),#fff5e6);
      color:var(--text);
      padding:24px;
      min-height:100vh;
    }
    .container{
      max-width:1200px;
      margin:auto;
      background:var(--card);
      border-radius:16px;
      box-shadow:var(--shadow-lg);
      overflow:hidden;
    }
    header{
      background:linear-gradient(90deg,var(--accent-red),var(--accent-orange));
      color:white;
      padding:20px 28px;
      display:flex;
      align-items:center;
      gap:16px;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    header h1{
      font-family:'Bebas Neue',sans-serif;
      font-size:1.8rem;
      margin:0;
      letter-spacing:1.2px;
    }
    header .sub{font-size:0.9rem;opacity:0.95;font-weight:300}
    .user-badge{
      background:rgba(255,255,255,0.2);
      padding:8px 16px;
      border-radius:20px;
      font-size:0.85rem;
      backdrop-filter:blur(10px);
    }

    .wrap{
      padding:28px;
      display:grid;
      grid-template-columns:360px 1fr;
      gap:24px;
    }
    .card{
      background:white;
      padding:24px;
      border-radius:14px;
      box-shadow:var(--shadow-md);
      border:1px solid #f5f5f5;
      transition:transform 0.2s, box-shadow 0.2s;
    }
    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 15px 40px rgba(0,0,0,0.08);
    }
    h2{
      margin-bottom:12px;
      font-family:'Bebas Neue',sans-serif;
      color:var(--accent-red);
      letter-spacing:1.5px;
      font-size:1.4rem;
    }
    h3{
      font-family:'Bebas Neue',sans-serif;
      color:var(--accent-orange);
      letter-spacing:1px;
      font-size:1.1rem;
    }

    .btn{
      padding:12px 18px;
      border:none;
      background:var(--accent-orange);
      color:white;
      font-weight:600;
      border-radius:10px;
      cursor:pointer;
      box-shadow:0 8px 24px rgba(255,122,45,0.18);
      transition:all 0.3s;
      font-size:14px;
      font-family:'Poppins',sans-serif;
    }
    .btn:hover{
      background:#FF8C4D;
      transform:translateY(-2px);
      box-shadow:0 12px 32px rgba(255,122,45,0.25);
    }
    .btn:active{transform:translateY(0)}
    .btn.ghost{
      background:white;
      color:#444;
      border:2px solid #eee;
      box-shadow:var(--shadow-sm);
    }
    .btn.ghost:hover{
      background:#f9f9f9;
      border-color:#ddd;
      transform:translateY(-2px);
    }
    .btn:disabled{
      opacity:0.5;
      cursor:not-allowed;
      transform:none !important;
    }
    .small{font-size:13px;color:var(--muted)}

    .control-row{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .metric{
      background:linear-gradient(135deg,#fff8f0,#ffead3);
      border:1px solid #ffd699;
      padding:16px;
      border-radius:12px;
      font-weight:700;
      color:var(--accent-red);
      margin-top:8px;
      font-size:15px;
      text-align:center;
      box-shadow:var(--shadow-sm);
    }

    .log{
      max-height:400px;
      overflow:auto;
      border-top:2px solid #f0f0f0;
      margin-top:16px;
      padding-top:16px;
      font-size:13px;
    }
    .log::-webkit-scrollbar{width:8px}
    .log::-webkit-scrollbar-track{background:#f5f5f5;border-radius:10px}
    .log::-webkit-scrollbar-thumb{background:#ddd;border-radius:10px}
    .log::-webkit-scrollbar-thumb:hover{background:#ccc}
    
    .log-entry{
      padding:12px 14px;
      border-radius:10px;
      background:#fafafa;
      box-shadow:var(--shadow-sm);
      margin-bottom:10px;
      border-left:4px solid #e0e0e0;
      transition:all 0.2s;
      animation:slideIn 0.3s ease-out;
    }
    .log-entry:hover{
      background:#f5f5f5;
      border-left-color:var(--accent-orange);
    }
    .log-entry.success{border-left-color:var(--success)}
    .log-entry.warning{border-left-color:var(--warning)}
    .log-entry.error{border-left-color:var(--error)}
    .log-entry .time{
      font-size:11px;
      color:#999;
      display:block;
      margin-bottom:4px;
    }
    .log-entry .msg{color:#333;line-height:1.4}

    @keyframes slideIn{
      from{opacity:0;transform:translateX(-10px)}
      to{opacity:1;transform:translateX(0)}
    }

    .flex{display:flex;gap:12px;align-items:center}
    input,select,textarea{
      padding:12px 14px;
      border-radius:10px;
      border:2px solid #eaeaea;
      width:100%;
      font-size:14px;
      font-family:'Poppins',sans-serif;
      transition:border-color 0.2s, box-shadow 0.2s;
    }
    input:focus,select:focus,textarea:focus{
      outline:none;
      border-color:var(--accent-orange);
      box-shadow:0 0 0 3px rgba(255,122,45,0.1);
    }
    textarea{resize:vertical;min-height:80px}

    #modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.5);
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:20px;
      backdrop-filter:blur(4px);
      animation:fadeIn 0.2s;
    }
    #modal.active{display:flex}
    @keyframes fadeIn{
      from{opacity:0}
      to{opacity:1}
    }
    .modal-card{
      background:#fff;
      border-radius:16px;
      padding:28px;
      width:100%;
      max-width:680px;
      box-shadow:0 25px 70px rgba(0,0,0,0.3);
      animation:modalSlide 0.3s ease-out;
      max-height:90vh;
      overflow-y:auto;
    }
    @keyframes modalSlide{
      from{transform:translateY(-20px);opacity:0}
      to{transform:translateY(0);opacity:1}
    }
    .modal-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
      margin-bottom:20px;
      padding-bottom:16px;
      border-bottom:2px solid #f0f0f0;
    }
    .modal-actions{display:flex;gap:10px}
    .progress{
      height:12px;
      background:#f0f0f0;
      border-radius:999px;
      overflow:hidden;
      margin-top:16px;
      box-shadow:inset 0 2px 4px rgba(0,0,0,0.08);
    }
    .progress > i{
      display:block;
      height:100%;
      width:0;
      background:linear-gradient(90deg,var(--accent-orange),var(--accent-red));
      transition:width .3s ease-out;
      border-radius:999px;
    }

    .mini-table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
    }
    .mini-table tr{transition:background 0.2s}
    .mini-table tr:hover{background:#fafafa}
    .mini-table td{
      padding:12px 8px;
      border-bottom:1px solid #f5f5f5;
    }
    .mini-table td:first-child{color:var(--muted);font-size:13px}
    .mini-table td:last-child{
      font-weight:600;
      text-align:right;
      color:var(--text);
    }

    .stats-grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
      margin-top:16px;
    }
    .stat-card{
      background:linear-gradient(135deg,#fafafa,#ffffff);
      padding:16px;
      border-radius:12px;
      text-align:center;
      border:1px solid #f0f0f0;
      box-shadow:var(--shadow-sm);
      transition:transform 0.2s;
    }
    .stat-card:hover{transform:translateY(-2px)}
    .stat-card .label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:6px;
    }
    .stat-card .value{
      font-size:20px;
      font-weight:700;
      color:var(--accent-red);
    }

    .alert{
      padding:14px 16px;
      border-radius:10px;
      margin-top:12px;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .alert.info{background:#dbeafe;color:#1e40af;border:1px solid #bfdbfe}
    .alert.success{background:#d1fae5;color:#065f46;border:1px solid #a7f3d0}
    .alert.warning{background:#fef3c7;color:#92400e;border:1px solid #fde68a}

    .form-group{margin-bottom:16px}
    .form-group label{
      display:block;
      margin-bottom:6px;
      font-weight:600;
      font-size:13px;
      color:#444;
    }
    .form-row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }

    #emptyState{
      display:none;
      text-align:center;
      padding:60px 20px;
      color:#999;
    }

    @media(max-width:900px){
      .wrap{grid-template-columns:1fr}
      .stats-grid{grid-template-columns:1fr}
      .form-row{grid-template-columns:1fr}
      header{padding:16px 20px}
      header h1{font-size:1.4rem}
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>üè¶ Stakeholder ‚Äî Banco</h1>
      <div class="sub">Sistema de Gesti√≥n Financiera ¬∑ Popeyes Operations</div>
    </div>
    <div class="user-badge">
      <span style="opacity:0.8">Usuario:</span> <strong>Banco Central</strong>
    </div>
  </header>

  <section class="wrap">
    <aside>
      <div class="card">
        <h2>Panel de Control</h2>
        <div class="small" style="margin-bottom:14px">Acciones r√°pidas y estados</div>

        <div class="control-row">
          <button class="btn" onclick="window.abrirModal('pago')">üí≥ Nuevo Pago</button>
          <button class="btn ghost" onclick="window.abrirModal('prestamo')">üìä Solicitar Pr√©stamo</button>
          <button class="btn ghost" onclick="window.abrirModal('reporte')">üìÑ Generar Reporte</button>
        </div>

        <h3 style="margin-top:20px">Estado del Sistema</h3>
        <div id="estadoBanco" class="metric">‚úì Sistema operativo</div>

        <h3 style="margin-top:20px">Resumen Financiero</h3>
        <table class="mini-table">
          <tr><td>Saldo disponible</td><td id="saldo">S/ 1,200,000.00</td></tr>
          <tr><td>Cr√©ditos activos</td><td id="creditos">2</td></tr>
          <tr><td>Pagos procesados hoy</td><td id="pagosHoy">0</td></tr>
          <tr><td>Operaciones pendientes</td><td id="pendientes">0</td></tr>
        </table>

        <div style="margin-top:20px">
          <button class="btn ghost" onclick="window.exportLog()" style="width:100%">
            üì• Exportar Actividad
          </button>
        </div>
      </div>

      <div class="card" style="margin-top:20px">
        <h3 style="margin-bottom:12px">Estad√≠sticas</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="label">Total Ingresos</div>
            <div class="value" id="totalIngresos">S/ 0</div>
          </div>
          <div class="stat-card">
            <div class="label">Total Egresos</div>
            <div class="value" id="totalEgresos">S/ 0</div>
          </div>
          <div class="stat-card">
            <div class="label">Operaciones</div>
            <div class="value" id="totalOps">0</div>
          </div>
        </div>
      </div>
    </aside>

    <section class="card">
      <h2>Registro de Operaciones</h2>
      <div class="small" style="margin-bottom:16px">
        Historial completo de transacciones y eventos del sistema
      </div>

      <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap">
        <input 
          id="filtro" 
          placeholder="üîç Buscar en el registro..." 
          oninput="window.filtrarLogs()" 
          style="flex:1;min-width:200px"
        />
        <select id="tipoFiltro" onchange="window.filtrarLogs()" style="width:auto">
          <option value="">Todos los tipos</option>
          <option value="pago">Pagos</option>
          <option value="pr√©stamo">Pr√©stamos</option>
          <option value="reporte">Reportes</option>
        </select>
        <button class="btn ghost" onclick="window.limpiarLogs()">üóëÔ∏è Limpiar</button>
      </div>

      <div id="emptyState">
        <div style="font-size:48px;margin-bottom:12px">üìã</div>
        <div style="font-size:16px;font-weight:600;margin-bottom:6px">No hay operaciones registradas</div>
        <div class="small">Las transacciones aparecer√°n aqu√≠</div>
      </div>

      <div class="log" id="logBanco"></div>
    </section>
  </section>
</div>

<div id="modal">
  <div class="modal-card">
    <div class="modal-head">
      <div style="flex:1">
        <h3 id="mTitle" style="margin:0"></h3>
        <div class="small" id="mSub" style="margin-top:4px"></div>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" onclick="window.closeModal()">Cancelar</button>
        <button class="btn" id="mAction">Procesar</button>
      </div>
    </div>
    <div id="mBody"></div>
    <div class="progress" id="mProgress" style="display:none"><i></i></div>
  </div>
</div>

<script>
(function() {
  const state = {
    logs: [],
    saldo: 1200000,
    creditos: 2,
    pagosHoy: 0,
    totalIngresos: 0,
    totalEgresos: 0,
    procesando: false
  };

  const elements = {
    log: document.getElementById('logBanco'),
    estado: document.getElementById('estadoBanco'),
    saldo: document.getElementById('saldo'),
    creditos: document.getElementById('creditos'),
    pagosHoy: document.getElementById('pagosHoy'),
    pendientes: document.getElementById('pendientes'),
    totalIngresos: document.getElementById('totalIngresos'),
    totalEgresos: document.getElementById('totalEgresos'),
    totalOps: document.getElementById('totalOps'),
    emptyState: document.getElementById('emptyState')
  };

  function formatMoney(amount) {
    return 'S/ ' + Number(amount).toLocaleString('es-PE', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  function formatDate(date) {
    return new Date(date).toLocaleString('es-PE', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
  }

  function getLogClass(msg) {
    const lower = msg.toLowerCase();
    if (lower.includes('aprobado') || lower.includes('registrado') || lower.includes('completado') || lower.includes('‚úì')) {
      return 'success';
    }
    if (lower.includes('rechazado') || lower.includes('error') || lower.includes('fallido') || lower.includes('‚úó')) {
      return 'error';
    }
    if (lower.includes('proceso') || lower.includes('pendiente') || lower.includes('‚è≥')) {
      return 'warning';
    }
    return '';
  }

  function addLog(msg, type = 'info') {
    const entry = {
      id: Date.now() + Math.random(),
      timestamp: new Date(),
      msg,
      type
    };
    state.logs.unshift(entry);
    
    if (state.logs.length > 500) {
      state.logs = state.logs.slice(0, 500);
    }
    
    renderLogs();
    updateStats();
  }

  function renderLogs(filter = '', typeFilter = '') {
    const filtered = state.logs.filter(l => {
      const matchText = l.msg.toLowerCase().includes(filter.toLowerCase());
      const matchType = !typeFilter || l.msg.toLowerCase().includes(typeFilter.toLowerCase());
      return matchText && matchType;
    });

    if (filtered.length === 0) {
      elements.log.style.display = 'none';
      elements.emptyState.style.display = 'block';
      return;
    }

    elements.log.style.display = 'block';
    elements.emptyState.style.display = 'none';
    
    elements.log.innerHTML = filtered.map(l => `
      <div class="log-entry ${getLogClass(l.msg)}">
        <span class="time">${formatDate(l.timestamp)}</span>
        <div class="msg">${l.msg}</div>
      </div>
    `).join('');
  }

  function updateStats() {
    elements.saldo.textContent = formatMoney(state.saldo);
    elements.creditos.textContent = state.creditos;
    elements.pagosHoy.textContent = state.pagosHoy;
    elements.totalIngresos.textContent = formatMoney(state.totalIngresos);
    elements.totalEgresos.textContent = formatMoney(state.totalEgresos);
    elements.totalOps.textContent = state.logs.length;
    
    const pendientes = state.logs.filter(l => 
      l.msg.toLowerCase().includes('pendiente') || 
      l.msg.toLowerCase().includes('proceso')
    ).length;
    elements.pendientes.textContent = pendientes;
  }

  window.abrirModal = function(type) {
    if (state.procesando) {
      alert('Ya hay una operaci√≥n en proceso. Por favor espera.');
      return;
    }

    const modal = document.getElementById('modal');
    const mTitle = document.getElementById('mTitle');
    const mSub = document.getElementById('mSub');
    const mBody = document.getElementById('mBody');
    const mAction = document.getElementById('mAction');
    const mProgress = document.getElementById('mProgress');

    mBody.innerHTML = '';
    mProgress.style.display = 'none';
    mProgress.querySelector('i').style.width = '0%';

    if (type === 'pago') {
      mTitle.textContent = 'üí≥ Nuevo Pago a Proveedor';
      mSub.textContent = 'Registra y procesa pagos de forma segura';
      mBody.innerHTML = `
        <div class="form-group">
          <label>Informaci√≥n del Proveedor</label>
          <div class="form-row">
            <input id="provName" placeholder="Nombre del proveedor" required />
            <input id="provId" placeholder="RUC / ID" required />
          </div>
        </div>
        <div class="form-group">
          <label>Detalles del Pago</label>
          <div class="form-row">
            <input id="amount" type="number" step="0.01" min="0.01" placeholder="Monto (S/)" required />
            <select id="method">
              <option>Transferencia bancaria</option>
              <option>Tarjeta de cr√©dito</option>
              <option>Yape / Plin</option>
              <option>Efectivo</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Concepto / Nota</label>
          <textarea id="note" placeholder="Descripci√≥n del pago (opcional)"></textarea>
        </div>
        <div class="alert info">
          ‚ÑπÔ∏è El pago ser√° procesado inmediatamente y se descontar√° del saldo disponible.
        </div>
      `;
      mAction.textContent = 'Procesar Pago';
      mAction.onclick = processPago;

    } else if (type === 'prestamo') {
      mTitle.textContent = 'üìä Solicitud de Pr√©stamo';
      mSub.textContent = 'Calcula y solicita financiamiento';
      mBody.innerHTML = `
        <div class="form-group">
          <label>Condiciones del Pr√©stamo</label>
          <div class="form-row">
            <input id="loanAmount" type="number" step="1000" min="1000" placeholder="Monto (S/)" required />
            <input id="loanMonths" type="number" min="1" max="120" placeholder="Plazo (meses)" required />
          </div>
        </div>
        <div class="form-group">
          <label>Tasa de Inter√©s</label>
          <select id="loanRate">
            <option value="6">6% anual (Preferencial)</option>
            <option value="8" selected>8% anual (Est√°ndar)</option>
            <option value="10">10% anual (Express)</option>
            <option value="12">12% anual (Alto riesgo)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Justificaci√≥n</label>
          <textarea id="loanReason" placeholder="Describe el motivo del pr√©stamo"></textarea>
        </div>
        <div id="loanCalc" class="alert info" style="display:none">
          <div>
            <strong>Cuota mensual estimada:</strong> <span id="cuotaMensual">-</span><br>
            <strong>Total a pagar:</strong> <span id="totalPagar">-</span>
          </div>
        </div>
      `;
      
      const calcLoan = () => {
        const amount = Number(document.getElementById('loanAmount').value) || 0;
        const months = Number(document.getElementById('loanMonths').value) || 0;
        const rate = Number(document.getElementById('loanRate').value) / 100 / 12;
        
        if (amount > 0 && months > 0) {
          const cuota = amount * (rate * Math.pow(1 + rate, months)) / (Math.pow(1 + rate, months) - 1);
          const total = cuota * months;
          
          document.getElementById('loanCalc').style.display = 'block';
          document.getElementById('cuotaMensual').textContent = formatMoney(cuota);
          document.getElementById('totalPagar').textContent = formatMoney(total);
        }
      };
      
      setTimeout(() => {
        document.getElementById('loanAmount').addEventListener('input', calcLoan);
        document.getElementById('loanMonths').addEventListener('input', calcLoan);
        document.getElementById('loanRate').addEventListener('change', calcLoan);
      }, 100);
      
      mAction.textContent = 'Solicitar Pr√©stamo';
      mAction.onclick = processPrestamo;

    } else if (type === 'reporte') {
      const today = new Date().toISOString().split('T')[0];
      const lastMonth = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
      
      mTitle.textContent = 'üìÑ Generar Reporte Financiero';
      mSub.textContent = 'Exporta datos para an√°lisis';
      mBody.innerHTML = `
        <div class="form-group">
          <label>Per√≠odo del Reporte</label>
          <div class="form-row">
            <input id="fromDate" type="date" value="${lastMonth}" max="${today}" required />
            <input id="toDate" type="date" value="${today}" max="${today}" required />
          </div>
        </div>
        <div class="form-group">
          <label>Formato de Exportaci√≥n</label>
          <select id="repFormat">
            <option value="CSV">CSV (Excel compatible)</option>
            <option value="JSON">JSON (Datos estructurados)</option>
            <option value="PDF">PDF (Imprimible)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Incluir en el reporte</label>
          <div style="display:flex;flex-direction:column;gap:8px">
            <label style="display:flex;align-items:center;gap:8px;font-weight:400">
              <input type="checkbox" id="inclPagos" checked> Pagos procesados
            </label>
            <label style="display:flex;align-items:center;gap:8px;font-weight:400">
              <input type="checkbox" id="inclPrestamos" checked> Pr√©stamos
            </label>
            <label style="display:flex;align-items:center;gap:8px;font-weight:400">
              <input type="checkbox" id="inclEstadisticas" checked> Estad√≠sticas
            </label>
          </div>
        </div>
        <div class="alert warning">
          ‚ö†Ô∏è El reporte incluir√° todas las operaciones del per√≠odo seleccionado.
        </div>
      `;
      mAction.textContent = 'Generar Reporte';
      mAction.onclick = processReporte;
    }

    modal.classList.add('active');
  };

  window.closeModal = function() {
    if (state.procesando) return;
    document.getElementById('modal').classList.remove('active');
  };

  /* -------------------------
     Procesamiento de Pago
     ------------------------- */
  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function processPago() {
    const provName = document.getElementById('provName').value.trim();
    const provId = document.getElementById('provId').value.trim();
    const amount = Number(document.getElementById('amount').value);
    const method = document.getElementById('method').value;
    const note = document.getElementById('note').value.trim();

    if (!provName || !provId) {
      alert('‚ö†Ô∏è Por favor completa el nombre y RUC del proveedor');
      return;
    }
    if (amount <= 0 || isNaN(amount)) {
      alert('‚ö†Ô∏è El monto debe ser mayor a cero');
      return;
    }
    if (amount > state.saldo) {
      alert('‚ö†Ô∏è Saldo insuficiente para procesar el pago');
      return;
    }

    // Mostrar progreso simulado
    const mProgress = document.getElementById('mProgress');
    const progressBar = mProgress.querySelector('i');
    mProgress.style.display = 'block';
    progressBar.style.width = '0%';

    state.procesando = true;
    const mAction = document.getElementById('mAction');
    mAction.disabled = true;

    // animaci√≥n de progreso
    let pct = 0;
    const interval = setInterval(() => {
      pct += Math.random() * 20;
      if (pct >= 95) pct = 95;
      progressBar.style.width = pct + '%';
    }, 250);

    try {
      // Simula verificaci√≥n (red, autorizaciones...)
      await sleep(1000 + Math.random()*1000);

      // Simula posible rechazo por verificaci√≥n (5% chance)
      if (Math.random() < 0.05) {
        throw new Error('Autorizaci√≥n rechazada por antifraude');
      }

      // Procesar pago: actualizar estado
      state.saldo = Number((state.saldo - amount).toFixed(2));
      state.pagosHoy += 1;
      state.totalEgresos = Number((state.totalEgresos + amount).toFixed(2));

      // registro
      addLog(`Pago registrado ‚úì ‚Äî Proveedor: ${provName} (${provId}) ‚Äî Monto: ${formatMoney(amount)} ‚Äî M√©todo: ${method} ${note ? '‚Äî Nota: '+note : ''}`, 'success');

      // finalizar progreso
      progressBar.style.width = '100%';
      await sleep(350);
    } catch (err) {
      addLog(`Pago fallido ‚úó ‚Äî ${err.message}`, 'error');
      alert('‚ùå Error al procesar pago: ' + err.message);
    } finally {
      clearInterval(interval);
      progressBar.style.width = '100%';
      state.procesando = false;
      mAction.disabled = false;
      document.getElementById('modal').classList.remove('active');
      // reset progress visually after short delay
      setTimeout(()=> {
        mProgress.style.display = 'none';
        progressBar.style.width = '0%';
      }, 400);
      updateStats();
    }
  }

  /* -------------------------
     Procesamiento de Pr√©stamo
     ------------------------- */
  async function processPrestamo() {
    const amount = Number(document.getElementById('loanAmount').value);
    const months = Number(document.getElementById('loanMonths').value);
    const rate = Number(document.getElementById('loanRate').value);
    const reason = document.getElementById('loanReason').value.trim();

    if (!amount || amount <= 0) {
      alert('‚ö†Ô∏è Ingresa un monto v√°lido para el pr√©stamo');
      return;
    }
    if (!months || months <= 0) {
      alert('‚ö†Ô∏è Ingresa un plazo v√°lido (meses)');
      return;
    }

    // Mostrar progreso
    const mProgress = document.getElementById('mProgress');
    const progressBar = mProgress.querySelector('i');
    mProgress.style.display = 'block';
    progressBar.style.width = '0%';

    state.procesando = true;
    const mAction = document.getElementById('mAction');
    mAction.disabled = true;

    let pct = 0;
    const interval = setInterval(() => {
      pct += Math.random() * 15;
      if (pct >= 95) pct = 95;
      progressBar.style.width = pct + '%';
    }, 250);

    try {
      await sleep(800 + Math.random() * 1200);

      // Regla simple de aprobaci√≥n (mock): si monto <= 50% del saldo actual => aprobado
      const aprobacion = amount <= (state.saldo * 0.5);

      if (aprobacion) {
        // Banco aprueba y a√±ade el monto al saldo (ingreso)
        state.saldo = Number((state.saldo + amount).toFixed(2));
        state.creditos += 1;
        state.totalIngresos = Number((state.totalIngresos + amount).toFixed(2));
        addLog(`Pr√©stamo aprobado ‚úì ‚Äî Monto: ${formatMoney(amount)} ‚Äî Plazo: ${months} meses ‚Äî Tasa: ${rate}% ‚Äî Motivo: ${reason || 'No especificado'}`, 'success');
      } else {
        // Si no aprobado, queda pendiente / rechazado seg√∫n caso (aqu√≠ marcamos como pendiente)
        addLog(`Pr√©stamo pendiente ‚è≥ ‚Äî Monto: ${formatMoney(amount)} ‚Äî Revisi√≥n necesaria (posible riesgo) ‚Äî Motivo: ${reason || 'No especificado'}`, 'warning');
      }

      progressBar.style.width = '100%';
      await sleep(350);
    } catch (err) {
      addLog(`Error solicitud pr√©stamo ‚úó ‚Äî ${err.message}`, 'error');
      alert('‚ùå Error al solicitar pr√©stamo: ' + err.message);
    } finally {
      clearInterval(interval);
      state.procesando = false;
      mAction.disabled = false;
      document.getElementById('modal').classList.remove('active');
      setTimeout(()=> {
        mProgress.style.display = 'none';
        progressBar.style.width = '0%';
      }, 400);
      updateStats();
    }
  }

  /* -------------------------
     Generar Reporte
     ------------------------- */
  function downloadBlob(filename, content, type='text/csv') {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function processReporte() {
    const from = document.getElementById('fromDate').value;
    const to = document.getElementById('toDate').value;
    const format = document.getElementById('repFormat').value;
    const inclPagos = document.getElementById('inclPagos').checked;
    const inclPrestamos = document.getElementById('inclPrestamos').checked;
    const inclEstadisticas = document.getElementById('inclEstadisticas').checked;

    if (!from || !to) {
      alert('‚ö†Ô∏è Selecciona un rango de fechas v√°lido');
      return;
    }
    const fromDate = new Date(from + 'T00:00:00');
    const toDate = new Date(to + 'T23:59:59');
    if (fromDate > toDate) {
      alert('‚ö†Ô∏è El rango de fechas es inv√°lido');
      return;
    }

    // Filtrar logs por fecha y tipo
    const filtered = state.logs.filter(l => {
      const t = new Date(l.timestamp);
      if (t < fromDate || t > toDate) return false;
      const lower = l.msg.toLowerCase();
      if (!inclPagos && lower.includes('pago')) return false;
      if (!inclPrestamos && lower.includes('pr√©stamo') && lower.indexOf('pr√©stamo') !== -1) return false;
      return true;
    });

    // Preparar contenido
    if (format === 'JSON') {
      const payload = {
        generatedAt: new Date().toISOString(),
        period: { from: fromDate.toISOString(), to: toDate.toISOString() },
        statistics: inclEstadisticas ? {
          saldo: state.saldo,
          creditos: state.creditos,
          pagosHoy: state.pagosHoy,
          totalIngresos: state.totalIngresos,
          totalEgresos: state.totalEgresos,
          totalOps: state.logs.length
        } : undefined,
        logs: filtered
      };
      const content = JSON.stringify(payload, null, 2);
      downloadBlob(`reporte_${from}_${to}.json`, content, 'application/json');
      addLog(`Reporte generado ‚úì (JSON) ‚Äî Per√≠odo: ${from} ‚Üí ${to} ‚Äî Registros: ${filtered.length}`, 'success');
      document.getElementById('modal').classList.remove('active');
      return;
    }

    if (format === 'CSV') {
      // CSV simple: timestamp, mensaje
      const rows = [['timestamp','mensaje']];
      filtered.forEach(l => rows.push([new Date(l.timestamp).toISOString(), `"${l.msg.replace(/"/g,'""')}"`]));
      if (inclEstadisticas) {
        rows.push([]);
        rows.push(['Estad√≠sticas','']);
        rows.push(['Saldo', state.saldo]);
        rows.push(['Cr√©ditos', state.creditos]);
        rows.push(['Pagos hoy', state.pagosHoy]);
        rows.push(['Total ingresos', state.totalIngresos]);
        rows.push(['Total egresos', state.totalEgresos]);
      }
      const csv = rows.map(r => r.join(',')).join('\n');
      downloadBlob(`reporte_${from}_${to}.csv`, csv, 'text/csv;charset=utf-8;');
      addLog(`Reporte generado ‚úì (CSV) ‚Äî Per√≠odo: ${from} ‚Üí ${to} ‚Äî Registros: ${filtered.length}`, 'success');
      document.getElementById('modal').classList.remove('active');
      return;
    }

    if (format === 'PDF') {
      // Generamos una vista imprimible (HTML) que el usuario puede imprimir/guardar como PDF manualmente
      let html = `
        <html>
        <head>
          <meta charset="utf-8"/>
          <title>Reporte ${from} - ${to}</title>
          <style>
            body{font-family:Arial,Helvetica,sans-serif;padding:20px;color:#222}
            h1{color:#e23a2b}
            table{width:100%;border-collapse:collapse;margin-top:12px}
            th,td{border:1px solid #ddd;padding:8px;text-align:left}
            th{background:#f7f7f7}
            .meta{margin-top:8px;font-size:13px;color:#555}
          </style>
        </head>
        <body>
          <h1>Reporte Financiero</h1>
          <div class="meta"><strong>Per√≠odo:</strong> ${from} ‚Üí ${to}</div>
          <div class="meta"><strong>Generado:</strong> ${new Date().toLocaleString()}</div>
      `;
      if (inclEstadisticas) {
        html += `
          <h3>Estad√≠sticas</h3>
          <table>
            <tr><th>Saldo</th><td>${formatMoney(state.saldo)}</td></tr>
            <tr><th>Cr√©ditos</th><td>${state.creditos}</td></tr>
            <tr><th>Pagos hoy</th><td>${state.pagosHoy}</td></tr>
            <tr><th>Total ingresos</th><td>${formatMoney(state.totalIngresos)}</td></tr>
            <tr><th>Total egresos</th><td>${formatMoney(state.totalEgresos)}</td></tr>
          </table>
        `;
      }
      html += `<h3>Registros (${filtered.length})</h3>`;
      html += `<table><thead><tr><th>Fecha</th><th>Mensaje</th></tr></thead><tbody>`;
      filtered.forEach(l => {
        html += `<tr><td>${new Date(l.timestamp).toLocaleString()}</td><td>${l.msg}</td></tr>`;
      });
      html += `</tbody></table>`;
      html += `</body></html>`;

      const w = window.open('', '_blank');
      w.document.write(html);
      w.document.close();
      // Informar al usuario que puede imprimir/guardar como PDF
      addLog(`Reporte generado ‚úì (Vista imprimible) ‚Äî Per√≠odo: ${from} ‚Üí ${to} ‚Äî Registros: ${filtered.length}`, 'success');
      document.getElementById('modal').classList.remove('active');
      return;
    }
  }

  /* -------------------------
     Exportar Actividad (bot√≥n lateral)
     ------------------------- */
  window.exportLog = function() {
    if (state.logs.length === 0) {
      alert('No hay actividad para exportar');
      return;
    }
    // Exportar como CSV por defecto
    const rows = [['timestamp','mensaje']];
    state.logs.slice().reverse().forEach(l => rows.push([new Date(l.timestamp).toISOString(), `"${l.msg.replace(/"/g,'""')}"`]));
    const csv = rows.map(r => r.join(',')).join('\n');
    downloadBlob(`actividad_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`, csv, 'text/csv;charset=utf-8;');
    addLog(`Exportaci√≥n de actividad ‚úì ‚Äî Registros exportados: ${state.logs.length}`, 'success');
  };

  /* -------------------------
     Filtrar y limpiar logs
     ------------------------- */
  window.filtrarLogs = function() {
    const filter = document.getElementById('filtro').value || '';
    const typeFilter = document.getElementById('tipoFiltro').value || '';
    renderLogs(filter, typeFilter);
  };

  window.limpiarLogs = function() {
    if (!confirm('¬øSeguro que deseas limpiar todos los registros? Esta acci√≥n no se puede deshacer.')) return;
    state.logs = [];
    // Notamos que no cambiamos saldo ni hist√≥ricos monetarios al limpiar logs.
    renderLogs();
    updateStats();
    addLog('Registro limpiado ‚úì ‚Äî Todos los logs eliminados', 'success');
  };

  /* -------------------------
     Inicializaci√≥n
     ------------------------- */
  // A√±adimos algunos logs de ejemplo para mostrar la interfaz al abrir (opcional)
  addLog('Sistema inicializado ‚úì ‚Äî Listo para operar', 'success');
  addLog('Conexi√≥n con pasarela bancaria establecida ‚úì', 'success');

  // Exponer funciones para debugging desde consola si se necesita
  window._state = state;
  window._addLog = addLog;

})();
</script>
</body>
</html>
